var RockInvoiceItems;(()=>{class _RockInvoiceItems{init(){new Field()}}
class Field{constructor(){this.li=document.currentScript.closest("li.Inputfield");this.addRowButton=this.li.querySelector(".add-row");this.tpl=this.li.querySelector("template");this.labels=this.li.querySelector("thead.labels");this.itemstable=this.li.querySelector("table.rockinvoice-items-table");this.totalstable=this.li.querySelector("table.totals");this.textarea=this.li.querySelector(".InputfieldContent > textarea");this.li._field=this;this.makeSortable();this.addRowButton.addEventListener("click",(e)=>{e.preventDefault();this.addRow()})}
addRow(){let clone=this.tpl.content.cloneNode(!0);this.li.querySelector("tbody").appendChild(clone);new Row(this);this.update()}
getTotals(){return{subtotal:this.subtotal(),vat:0,grandtotal:this.grandtotal(),}}
grandtotal(){let total=0;this.items().forEach((tr)=>{total+=tr._row.total(!0)});return total}
items(){return this.itemstable.querySelectorAll("tbody.items > tr")}
itemsJSON(){return Array.from(this.items()).map((tr)=>{return{text:"TBD",net:tr.querySelector(".net input").value,vat:tr.querySelector(".vat input").value,quantity:tr.querySelector(".quantity input").value,}})}
makeSortable(){$(this.itemstable.querySelector("tbody")).sortable({handle:".sort-handle",cursor:"grabbing",update:()=>this.update(),})}
sleep(){if(!this.items().length){this.textarea.value="";return}
this.textarea.value=JSON.stringify({items:this.itemsJSON(),totals:JSON.stringify(this.getTotals()),},null,0)}
subtotal(){let subtotal=0;this.items().forEach((tr)=>{subtotal+=tr._row.total()});return subtotal}
update(){if(this.items().length>0){this.totalstable.removeAttribute("hidden");this.labels.removeAttribute("hidden");let totals=this.getTotals();this.totalstable.querySelector(".subtotal").textContent=totals.subtotal.toFixed(2);this.totalstable.querySelector(".grandtotal").textContent=totals.grandtotal.toFixed(2)}else{this.totalstable.setAttribute("hidden","");this.labels.setAttribute("hidden","")}
this.sleep()}}
class Row{constructor(field){this.field=field;this.tr=field.li.querySelector("tbody tr:last-child");this.deleteButton=this.tr.querySelector(".delete-row");this.rowTotal=this.tr.querySelector(".total > strong");this.tr._row=this;this.deleteButton.addEventListener("click",(e)=>{e.preventDefault();this.deleteRow(this.deleteButton)});this.selectOnClick();this.monitorInputs();this.update()}
deleteRow(button){button.closest("tr").remove();this.update()}
monitorInputs(){this.tr.querySelectorAll("input").forEach((input)=>{["input","change"].forEach((event)=>{input.addEventListener(event,()=>{this.update()})})})}
net(){return parseFloat(this.tr.querySelector(".net input").value)}
quantity(){return parseFloat(this.tr.querySelector(".quantity input").value)}
selectOnClick(){this.tr.querySelectorAll("input").forEach((input)=>{input.addEventListener("click",()=>{input.select()})})}
total(withVAT=!1){const total=this.net()*this.quantity();if(!withVAT)return total;return total*(1+this.vat()/100)}
update(){this.rowTotal.textContent=this.total().toFixed(2);this.field.update()}
vat(){return parseFloat(this.tr.querySelector(".vat input").value)}}
RockInvoiceItems=new _RockInvoiceItems()})()