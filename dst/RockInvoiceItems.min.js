const RockInvoiceItems=(()=>{let textareaCount=0;class RockInvoiceItems{init(){new Field()}}
class Field{constructor(){this.li=document.currentScript.closest("li.Inputfield");this.addRowButton=this.li.querySelector(".add-row");this.tpl=this.li.querySelector("template");this.labels=this.li.querySelector("thead.labels");this.itemstable=this.li.querySelector("table.rockinvoice-items-table");this.totalstable=this.li.querySelector("table.totals");this.textarea=this.li.querySelector(".InputfieldContent > textarea");this.li._field=this;this.makeSortable();this.wakeup();this.addRowButton.addEventListener("click",(e)=>{e.preventDefault();this.addRow()})}
addRow(){let clone=this.tpl.content.cloneNode(!0);this.li.querySelector("tbody").appendChild(clone);const item=new Item(this);return item}
getTotals(){return{subtotal:this.subtotal(),vat:this.getVatArray(),grandtotal:this.grandtotal(),}}
getVatArray(){const vatArray={};this.items().forEach((item)=>{const vatRate=item.vat();if(!vatRate)return;const vatValue=(item.total()*vatRate)/100;vatArray[vatRate]=(vatArray[vatRate]||0)+vatValue});Object.keys(vatArray).forEach((key)=>{vatArray[key]=Number(vatArray[key]).toFixed(2);if(vatArray[key]==="0.00")delete vatArray[key]});return vatArray}
grandtotal(){return this.items().reduce((total,item)=>total+item.total(!0),0)}
items(){const rows=this.itemstable.querySelectorAll("tbody.items > tr");return Array.from(rows).map((tr)=>tr._item).filter((item)=>item)}
itemsArray(){return this.items().map((item)=>item.toArray())}
makeSortable(){$(this.itemstable.querySelector("tbody")).sortable({handle:".sort-handle",cursor:"grabbing",update:()=>this.update(),})}
sleep(){if(!this.items().length){this.textarea.value="";return}
this.textarea.value=JSON.stringify({items:this.itemsArray(),})}
subtotal(){return this.items().reduce((subtotal,item)=>subtotal+item.total(),0)}
update(){if(this.items().length>0){this.totalstable.removeAttribute("hidden");this.labels.removeAttribute("hidden");let totals=this.getTotals();this.totalstable.querySelector(".subtotal").textContent=totals.subtotal.toFixed(2);this.totalstable.querySelector(".grandtotal").textContent=totals.grandtotal.toFixed(2);this.updateVatTotals()}else{this.totalstable.setAttribute("hidden","");this.labels.setAttribute("hidden","")}
this.sleep()}
updateVatTotals(){let vatArray=this.getVatArray();this.totalstable.querySelectorAll("tr.vattotal:not([hidden])").forEach((tr)=>tr.remove());const tpl=this.totalstable.querySelector("tr.vattotal[hidden]");for(const[key,value]of Object.entries(vatArray)){const clone=tpl.cloneNode(!0);clone.querySelector(".rate").textContent=key+"%";clone.querySelector(".value").textContent=value;clone.removeAttribute("hidden");this.totalstable.querySelector("tbody tr:last-child").before(clone)}}
wakeup(){const data=JSON.parse(this.textarea.value);if(data.items){data.items.forEach((item)=>{this.addRow().setData(item.text,item.net,item.vat,item.quantity)})}}}
class Item{constructor(field,addedItem){this.field=field;this.tr=addedItem||field.li.querySelector("tbody tr:last-child");this.deleteButton=this.tr.querySelector(".delete-row");this.cloneButton=this.tr.querySelector(".clone-row");this.itemTotal=this.tr.querySelector(".total > strong");this.tr._item=this;this.addTinyMCE();this.deleteButton.addEventListener("click",(e)=>{e.preventDefault();this.deleteItem(this.deleteButton)});this.cloneButton.addEventListener("click",(e)=>{e.preventDefault();this.clone()});this.selectOnClick();this.monitorInputs();this.update()}
addTinyMCE(){const id="rockinvoiceitems-tinymce-"+ ++textareaCount;const divID="rockinvoiceitems-inline-"+textareaCount;const textarea=this.tr.querySelector(".text textarea");textarea.id=id;textarea.addEventListener("input",(e)=>{const editor=tinymce.get(divID);if(editor)editor.setContent(e.target.value);});this.tr.querySelector(".text > div").id=divID;tinymce.init({selector:"#"+divID,branding:!1,statusbar:!1,menubar:!1,inline:!0,toolbar:"bold italic bullist numlist",toolbar_location:"top",toolbar_sticky:!0,plugins:"lists autoresize",height:"auto",autoresize_bottom_margin:0,setup:(editor)=>{editor.on("init",()=>{const textarea=document.getElementById(id);editor.setContent(textarea.value)});editor.on("input keyup change",()=>{const textarea=document.getElementById(id);textarea.value=editor.getContent();this.update()})},})}
clone(){const clone=this.tr.cloneNode(!0);this.tr.after(clone);const addedItem=this.tr.nextElementSibling;new Item(this.field,addedItem);this.update()}
deleteItem(button){button.closest("tr").remove();this.update()}
monitorInputs(){this.tr.querySelectorAll("input").forEach((input)=>{["input","change"].forEach((event)=>{input.addEventListener(event,()=>{this.update()})})});this.tr.querySelector(".text textarea").addEventListener("input",()=>{this.update()})}
net(){return parseFloat(this.tr.querySelector(".net input").value)}
quantity(){return parseFloat(this.tr.querySelector(".quantity input").value)}
selectOnClick(){this.tr.querySelectorAll("input").forEach((input)=>{input.addEventListener("click",()=>{input.select()})})}
setData(text,net,vat,quantity){this.tr.querySelector(".text textarea").value=text;this.tr.querySelector(".net input").value=net;this.tr.querySelector(".vat input").value=vat;this.tr.querySelector(".quantity input").value=quantity;this.update()}
text(){return this.tr.querySelector(".text textarea").value}
toArray(){return{text:this.text(),net:this.net(),vat:this.vat(),quantity:this.quantity(),}}
total(withVAT=!1){const total=this.net()*this.quantity();if(!withVAT)return total;return total*(1+this.vat()/100)}
update(){this.itemTotal.textContent=this.total().toFixed(2);this.field.update()}
vat(){return parseFloat(this.tr.querySelector(".vat input").value)}}
return new RockInvoiceItems()})()